<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Programming Environment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        #blocklyDiv {
            height: 100vh;
            width: 100vw;
            background: #fafafa;
        }

        /* Style the Blockly toolbox */
        .blocklyToolboxDiv {
            background: #f8f9fb !important;
            padding: 10px 0 !important;
        }

        .blocklyTreeRow {
            padding: 12px 16px !important;
            margin: 4px 8px !important;
            border-radius: 8px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            display: flex !important;
            align-items: center !important;
        }

        .blocklyTreeRow:hover {
            background-color: #e5e7eb !important;
        }

        .blocklyTreeSelected .blocklyTreeRow {
            background: #667eea !important;
            color: white !important;
        }

        .blocklyFlyoutBackground {
            fill: #ffffff !important;
        }

        .blocklyMainBackground {
            fill: #fafafa !important;
        }

        .blocklyScrollbarHandle {
            fill: #d1d5db !important;
        }

        /* Zoom controls styling */
        .blocklyZoom {
            bottom: 20px !important;
            right: 20px !important;
        }

        .blocklyTrash {
            bottom: 20px !important;
            right: 100px !important;
        }
    </style>
</head>
<body>
    <div id="blocklyDiv"></div>

    <!-- Blockly from CDN -->
    <script src="https://unpkg.com/blockly@11.0.0/blockly.min.js"></script>

    <!-- Toolbox definition -->
    <xml id="toolbox" style="display: none">
        <category name="üöÄ Movement" colour="#10b981">
            <block type="move_forward"></block>
            <block type="move_backward"></block>
            <block type="turn_left"></block>
            <block type="turn_right"></block>
            <block type="move_steps">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">5</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="üîÑ Control" colour="#8b5cf6">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">3</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
            <block type="controls_if"></block>
            <block type="controls_if">
                <mutation else="1"></mutation>
            </block>
        </category>
        <category name="üî¢ Numbers" colour="#f59e0b">
            <block type="math_number">
                <field name="NUM">1</field>
            </block>
            <block type="math_arithmetic">
                <value name="A">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="B">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_random_int">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="üìä Variables" colour="#ec4899" custom="VARIABLE"></category>
        <category name="‚ö° Functions" colour="#06b6d4" custom="PROCEDURE"></category>
    </xml>

    <script>
        let workspace = null;

        // Initialize on load
        window.addEventListener('load', function() {
            setTimeout(initializeEverything, 500);
        });

        function initializeEverything() {
            if (typeof Blockly === 'undefined') {
                console.error('Blockly not loaded');
                document.getElementById('blocklyDiv').innerHTML = 
                    '<div style="padding: 40px; color: red; text-align: center;">Error loading Blockly. Please refresh the page.</div>';
                return;
            }

            defineCustomBlocks();
            initWorkspace();
            setupCodeGeneration();
        }

        function defineCustomBlocks() {
            // Move Forward
            Blockly.Blocks['move_forward'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("‚û°Ô∏è Move Forward");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#10b981');
                    this.setTooltip("Move the robot forward one step");
                }
            };

            // Move Backward
            Blockly.Blocks['move_backward'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("‚¨ÖÔ∏è Move Backward");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#10b981');
                    this.setTooltip("Move the robot backward one step");
                }
            };

            // Turn Left
            Blockly.Blocks['turn_left'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("‚Ü∫ Turn Left");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#10b981');
                    this.setTooltip("Turn the robot 90 degrees left");
                }
            };

            // Turn Right
            Blockly.Blocks['turn_right'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("‚Üª Turn Right");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#10b981');
                    this.setTooltip("Turn the robot 90 degrees right");
                }
            };

            // Move Steps
            Blockly.Blocks['move_steps'] = {
                init: function() {
                    this.appendValueInput("STEPS")
                        .setCheck("Number")
                        .appendField("üèÉ Move");
                    this.appendDummyInput()
                        .appendField("steps");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#10b981');
                    this.setTooltip("Move the robot a specific number of steps");
                }
            };
        }

        function initWorkspace() {
            try {
                workspace = Blockly.inject('blocklyDiv', {
                    toolbox: document.getElementById('toolbox'),
                    grid: {
                        spacing: 25,
                        length: 1,
                        colour: '#e5e7eb',
                        snap: true
                    },
                    zoom: {
                        controls: true,
                        wheel: true,
                        startScale: 1.0,  // Smaller blocks as requested
                        maxScale: 2,
                        minScale: 0.4,
                        scaleSpeed: 1.1
                    },
                    trashcan: true,
                    renderer: 'zelos',
                    theme: {
                        'base': Blockly.Themes.Classic,
                        'componentStyles': {
                            'workspaceBackgroundColour': '#fafafa',
                            'toolboxBackgroundColour': '#f8f9fb',
                            'flyoutBackgroundColour': '#ffffff',
                            'scrollbarColour': '#d1d5db',
                            'insertionMarkerColour': '#667eea',
                            'insertionMarkerOpacity': 0.3,
                            'cursorColour': '#667eea'
                        },
                        'fontStyle': {
                            'size': 12,
                            'weight': '600'
                        }
                    }
                });

                // Add sample blocks
                const startBlocks = `
                <xml>
                    <block type="controls_repeat_ext" x="100" y="50">
                        <value name="TIMES">
                            <shadow type="math_number">
                                <field name="NUM">4</field>
                            </shadow>
                        </value>
                        <statement name="DO">
                            <block type="move_steps">
                                <value name="STEPS">
                                    <shadow type="math_number">
                                        <field name="NUM">3</field>
                                    </shadow>
                                </value>
                                <next>
                                    <block type="turn_right"></block>
                                </next>
                            </block>
                        </statement>
                    </block>
                </xml>`;
                
                Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(startBlocks), workspace);

            } catch (error) {
                console.error('Error initializing workspace:', error);
            }
        }

        function setupCodeGeneration() {
            if (!Blockly.JavaScript) {
                if (window.javascriptGenerator) {
                    Blockly.JavaScript = window.javascriptGenerator;
                } else {
                    Blockly.JavaScript = new Blockly.Generator('JavaScript');
                }
            }

            // Code generators
            Blockly.JavaScript['move_forward'] = function(block) {
                return 'moveForward();\n';
            };

            Blockly.JavaScript['move_backward'] = function(block) {
                return 'moveBackward();\n';
            };

            Blockly.JavaScript['turn_left'] = function(block) {
                return 'turnLeft();\n';
            };

            Blockly.JavaScript['turn_right'] = function(block) {
                return 'turnRight();\n';
            };

            Blockly.JavaScript['move_steps'] = function(block) {
                var value_steps = Blockly.JavaScript.valueToCode(block, 'STEPS', 
                    Blockly.JavaScript.ORDER_ATOMIC) || '1';
                return 'moveSteps(' + value_steps + ');\n';
            };
        }
    </script>
</body>
</html>